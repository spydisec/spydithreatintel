name: Validate and Auto-Merge Threat Intelligence Updates

on:
  push:
    branches:
      - auto-updates

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Blocklist Data
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout auto-updates branch
        uses: actions/checkout@v4
        with:
          ref: auto-updates
          fetch-depth: 1

      - name: Validate IP blocklist format
        run: |
          echo "ðŸ” Validating IP blocklists..."

          # Check high confidence IP list
          if [ -f iplist/high/high_confidence_limited.txt ]; then
            # Count valid IPv4 addresses (optimized with grep -c)
            valid_ipv4=$(grep -cE '^([0-9]{1,3}\.){3}[0-9]{1,3}$' iplist/high/high_confidence_limited.txt || echo 0)
            # Count valid IPv6 addresses
            valid_ipv6=$(grep -cE '^([0-9a-fA-F:]+)$' iplist/high/high_confidence_limited.txt || echo 0)
            total_valid=$((valid_ipv4 + valid_ipv6))

            echo "âœ… Found $total_valid valid IPs ($valid_ipv4 IPv4, $valid_ipv6 IPv6)"

            if [ $total_valid -lt 10 ]; then
              echo "âŒ Error: Too few valid IPs ($total_valid). Expected at least 10."
              exit 1
            fi
          else
            echo "âŒ Error: High confidence IP list not found"
            exit 1
          fi

          echo "âœ… IP validation passed"

      - name: Validate domain blocklist format
        run: |
          echo "ðŸ” Validating domain blocklists..."

          # Note: malicious_domains.txt is hosted on Cloudflare R2 (too large for GitHub)
          # Validate other domain sources instead
          if [ -f domainlist/malicious/domain_ioc_maltrail_new.txt ]; then
            valid_domains=$(grep -cE '^[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?)+$' domainlist/malicious/domain_ioc_maltrail_new.txt || echo 0)
            echo "âœ… Found $valid_domains valid IOC domains (Maltrail feed)"

            if [ $valid_domains -lt 10 ]; then
              echo "âŒ Error: Too few valid domains in IOC feed ($valid_domains)"
              exit 1
            fi
          fi

          # Check ads/tracking domains
          if [ -f domainlist/ads/advtracking_domains.txt ]; then
            valid_ads=$(grep -cE '^[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?)+$' domainlist/ads/advtracking_domains.txt || echo 0)
            echo "âœ… Found $valid_ads valid ads/tracking domains"

            if [ $valid_ads -lt 10 ]; then
              echo "âŒ Error: Too few valid ads domains ($valid_ads)"
              exit 1
            fi
          else
            echo "âŒ Error: Ads/tracking domain list not found"
            exit 1
          fi

          echo "âœ… Domain validation passed"

      - name: Validate file sizes
        run: |
          echo "ðŸ” Checking file sizes..."

          # Check that key files have reasonable sizes (optimized with stat)
          for file in iplist/high/high_confidence_limited.txt domainlist/ads/advtracking_domains.txt; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || wc -c < "$file")
              if [ $size -lt 100 ]; then
                echo "âŒ Error: $file is suspiciously small ($size bytes)"
                exit 1
              fi
              echo "âœ… $file: $size bytes"
            fi
          done
          
          echo "âœ… File size validation passed"

      - name: Summary
        run: |
          echo "ðŸ“Š Validation Summary:"
          echo "âœ… IP format validation passed"
          echo "âœ… Domain format validation passed"
          echo "âœ… No empty files detected"
          echo "âœ… File sizes validated"
          echo ""
          echo "ðŸŽ‰ All validation checks passed!"

  merge:
    name: Auto-Merge to Main
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Optimize Git for better performance with large repos
          git config merge.renameLimit 999999
          git config diff.renameLimit 999999

      - name: Merge auto-updates into main
        run: |
          echo "ðŸ”€ Merging auto-updates branch into main..."
          
          # Fetch the auto-updates branch with full history
          echo "ðŸ“¥ Fetching auto-updates branch..."
          git fetch origin auto-updates:auto-updates
          
          # Check current state
          echo "ðŸ“Š Repository state:"
          echo "  Main branch: $(git rev-parse --short HEAD)"
          echo "  Auto-updates: $(git rev-parse --short auto-updates)"
          
          # Check if already up to date
          if git merge-base --is-ancestor auto-updates HEAD; then
            echo "âœ… auto-updates is already merged (main is up to date)"
            exit 0
          fi
          
          # Perform the merge
          echo "ðŸ”€ Executing merge..."
          if git merge auto-updates --no-ff -m "ðŸ¤– Auto-merge: Threat intelligence update $(date -u '+%Y-%m-%d %H:%M:%S UTC')"; then
            echo "âœ… Merge completed successfully"
          else
            echo "âŒ Merge failed - checking status"
            git status
            exit 1
          fi

      - name: Push to main
        run: |
          echo "ðŸ“¤ Pushing changes to main branch..."
          git push origin main
          echo "âœ… Successfully pushed to main"

      - name: Create deployment tag
        run: |
          TAG="deploy-$(date -u '+%Y%m%d-%H%M%S')"
          echo "ðŸ·ï¸ Creating deployment tag: $TAG"

          git tag -a "$TAG" -m "Automated deployment $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin "$TAG"

          echo "âœ… Deployment tag created: $TAG"

      - name: Summary
        run: |
          echo "ðŸ“Š Merge Summary:"
          echo "âœ… auto-updates merged into main"
          echo "âœ… Changes pushed to GitHub"
          echo "âœ… Deployment tag created"
          echo ""
          echo "ðŸŽ‰ Auto-merge workflow completed successfully!"
          echo ""
          echo "ðŸ“ Latest commit:"
          git log -1 --oneline
