name: Validate and Auto-Merge Threat Intelligence Updates

on:
  push:
    branches:
      - auto-updates

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Blocklist Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout auto-updates branch
        uses: actions/checkout@v4
        with:
          ref: auto-updates

      - name: Validate IP blocklist format
        run: |
          echo "üîç Validating IP blocklists..."

          # Check high confidence IP list
          if [ -f iplist/high/high_confidence_limited.txt ]; then
            # Count valid IPv4 addresses
            valid_ipv4=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}$' iplist/high/high_confidence_limited.txt | wc -l)
            # Count valid IPv6 addresses
            valid_ipv6=$(grep -E '^([0-9a-fA-F:]+)$' iplist/high/high_confidence_limited.txt | wc -l)
            total_valid=$((valid_ipv4 + valid_ipv6))

            echo "‚úÖ Found $total_valid valid IPs ($valid_ipv4 IPv4, $valid_ipv6 IPv6)"

            if [ $total_valid -lt 10 ]; then
              echo "‚ùå Error: Too few valid IPs ($total_valid). Expected at least 10."
              exit 1
            fi
          else
            echo "‚ùå Error: High confidence IP list not found"
            exit 1
          fi

          echo "‚úÖ IP validation passed"

      - name: Validate domain blocklist format
        run: |
          echo "üîç Validating domain blocklists..."

          # Note: malicious_domains.txt is hosted on Cloudflare R2 (too large for GitHub)
          # Validate other domain sources instead
          if [ -f domainlist/malicious/domain_ioc_maltrail_new.txt ]; then
            valid_domains=$(grep -E '^[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?)+$' domainlist/malicious/domain_ioc_maltrail_new.txt | wc -l)
            echo "‚úÖ Found $valid_domains valid IOC domains (Maltrail feed)"

            if [ $valid_domains -lt 10 ]; then
              echo "‚ùå Error: Too few valid domains in IOC feed ($valid_domains)"
              exit 1
            fi
          fi

          # Check ads/tracking domains
          if [ -f domainlist/ads/advtracking_domains.txt ]; then
            valid_ads=$(grep -E '^[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?)+$' domainlist/ads/advtracking_domains.txt | wc -l)
            echo "‚úÖ Found $valid_ads valid ads/tracking domains"

            if [ $valid_ads -lt 10 ]; then
              echo "‚ùå Error: Too few valid ads domains ($valid_ads)"
              exit 1
            fi
          else
            echo "‚ùå Error: Ads/tracking domain list not found"
            exit 1
          fi

          echo "‚úÖ Domain validation passed"

      - name: Check for empty files
        run: |
          echo "üîç Checking for empty blocklist files..."

          # Find empty .txt files in iplist and domainlist
          empty_files=$(find iplist domainlist -type f -name "*.txt" -empty 2>/dev/null)

          if [ -n "$empty_files" ]; then
            echo "‚ùå Error: Found empty files:"
            echo "$empty_files"
            exit 1
          fi

          echo "‚úÖ No empty files found"

      - name: Validate file sizes
        run: |
          echo "üîç Checking file sizes..."

          # Check that key files have reasonable sizes
          for file in iplist/high/high_confidence_limited.txt domainlist/ads/advtracking_domains.txt; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              if [ $size -lt 100 ]; then
                echo "‚ùå Error: $file is suspiciously small ($size bytes)"
                exit 1
              fi
              echo "‚úÖ $file: $size bytes"
            fi
          done

      - name: Summary
        run: |
          echo "üìä Validation Summary:"
          echo "‚úÖ IP format validation passed"
          echo "‚úÖ Domain format validation passed"
          echo "‚úÖ No empty files detected"
          echo "‚úÖ File sizes validated"
          echo ""
          echo "üéâ All validation checks passed!"

  merge:
    name: Auto-Merge to Main
    needs: validate
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge auto-updates into main
        run: |
          echo "üîÄ Merging auto-updates branch into main..."

          # Fetch latest auto-updates
          git fetch origin auto-updates

          # Merge with no-ff to preserve history
          git merge origin/auto-updates --no-ff -m "ü§ñ Auto-merge: Threat intelligence update $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          echo "‚úÖ Merge completed successfully"

      - name: Push to main
        run: |
          echo "üì§ Pushing changes to main branch..."
          git push origin main
          echo "‚úÖ Successfully pushed to main"

      - name: Create deployment tag
        run: |
          TAG="deploy-$(date -u '+%Y%m%d-%H%M%S')"
          echo "üè∑Ô∏è Creating deployment tag: $TAG"

          git tag -a "$TAG" -m "Automated deployment $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin "$TAG"

          echo "‚úÖ Deployment tag created: $TAG"

      - name: Summary
        run: |
          echo "üìä Merge Summary:"
          echo "‚úÖ auto-updates merged into main"
          echo "‚úÖ Changes pushed to GitHub"
          echo "‚úÖ Deployment tag created"
          echo ""
          echo "üéâ Auto-merge workflow completed successfully!"
          echo ""
          echo "üìç Latest commit:"
          git log -1 --oneline
